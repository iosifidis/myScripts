#!/bin/bash

# ==============================================================================
# Σενάριο για την αυτοματοποιημένη αναβάθμιση του Fedora Linux στην επόμενη έκδοση.
# Βασισμένο στην επίσημη τεκμηρίωση του Fedora:
# https://docs.fedoraproject.org/en-US/quick-docs/upgrading-fedora-offline/
#
# Χρήση:
# 1. Αποθηκεύστε το αρχείο ως fedora_upgrade.sh
# 2. Δώστε του δικαιώματα εκτέλεσης: chmod +x fedora_upgrade.sh
# 3. Εκτελέστε το με δικαιώματα διαχειριστή: sudo ./fedora_upgrade.sh
# ==============================================================================

# Έξοδος σε περίπτωση σφάλματος
set -e

# --- Έλεγχος για δικαιώματα διαχειριστή (root) ---
if [[ $EUID -ne 0 ]]; then
   echo "Αυτό το σενάριο πρέπει να εκτελεστεί με δικαιώματα διαχειριστή (sudo)." 
   exit 1
fi

# --- Προειδοποίηση και επιβεβαίωση ---
echo "========================================================="
echo " ΠΡΟΕΙΔΟΠΟΙΗΣΗ: ΠΡΙΝ ΣΥΝΕΧΙΣΕΤΕ"
echo "========================================================="
echo "Η αναβάθμιση του συστήματος είναι μια διαδικασία με πιθανούς κινδύνους."
echo "Βεβαιωθείτε ότι έχετε δημιουργήσει ένα ΠΛΗΡΕΣ ΑΝΤΙΓΡΑΦΟ ΑΣΦΑΛΕΙΑΣ"
echo "των σημαντικών σας δεδομένων πριν ξεκινήσετε."
echo "========================================================="
echo ""

# --- Προσδιορισμός εκδόσεων ---
CURRENT_VERSION=$(grep -oP '(?<=^VERSION_ID=)\d+' /etc/os-release)
if [ -z "$CURRENT_VERSION" ]; then
    echo "Σφάλμα: Δεν ήταν δυνατός ο προσδιορισμός της τρέχουσας έκδοσης του Fedora."
    exit 1
fi
TARGET_VERSION=$((CURRENT_VERSION + 1))

echo "Αυτό το σενάριο θα επιχειρήσει να αναβαθμίσει το Fedora από την έκδοση $CURRENT_VERSION στην έκδοση $TARGET_VERSION."
read -p "Έχετε δημιουργήσει αντίγραφα ασφαλείας και είστε έτοιμοι να προχωρήσετε; (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Η διαδικασία αναβάθμισης ακυρώθηκε."
    exit 1
fi

# --- Βήμα 1: Ενημέρωση του τρέχοντος συστήματος ---
echo ""
echo "--- Βήμα 1/3: Ενημέρωση όλων των πακέτων στην τρέχουσα έκδοση $CURRENT_VERSION ---"
dnf upgrade --refresh
echo "Η ενημέρωση του συστήματος ολοκληρώθηκε."
echo ""

# --- Βήμα 2: Λήψη πακέτων για τη νέα έκδοση ---
echo "--- Βήμα 2/3: Λήψη πακέτων για το Fedora $TARGET_VERSION ---"
if ! dnf system-upgrade download --releasever=$TARGET_VERSION; then
    echo ""
    echo "Η λήψη απέτυχε. Αυτό συνήθως οφείλεται σε μη ικανοποιημένες εξαρτήσεις."
    echo "Η τεκμηρίωση προτείνει τη χρήση της σημαίας '--allowerasing' για την αφαίρεση πακέτων που προκαλούν προβλήματα."
    echo ""
    read -p "Θέλετε να προσπαθήσετε ξανά με την επιλογή --allowerasing; (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "Επανάληψη λήψης με την επιλογή --allowerasing..."
        dnf system-upgrade download --releasever=$TARGET_VERSION --allowerasing
    else
        echo "Η διαδικασία αναβάθμισης ακυρώθηκε."
        exit 1
    fi
fi
echo "Η λήψη των πακέτων αναβάθμισης ολοκληρώθηκε με επιτυχία."
echo ""

# --- Βήμα 3: Εκκίνηση της διαδικασίας αναβάθμισης ---
echo "--- Βήμα 3/3: Εκκίνηση της διαδικασίας αναβάθμισης ---"
echo "Όλα τα πακέτα έχουν ληφθεί."
echo "Το σύστημά σας θα επανεκκινηθεί τώρα στο περιβάλλον αναβάθμισης."
echo "ΚΛΕΙΣΤΕ ΟΛΕΣ ΤΙΣ ΕΦΑΡΜΟΓΕΣ ΚΑΙ ΑΠΟΘΗΚΕΥΣΤΕ ΤΗΝ ΕΡΓΑΣΙΑ ΣΑΣ."
read -p "Πατήστε οποιοδήποτε πλήκτρο για να ξεκινήσει η επανεκκίνηση για αναβάθμιση..."

# Επιλογή της σωστής εντολής με βάση την τρέχουσα έκδοση του Fedora
# (σύμφωνα με τη σελίδα 4 της τεκμηρίωσης)
if [ "$CURRENT_VERSION" -ge 41 ]; then
    echo "Χρήση εντολής DNF5 (για Fedora 41+)..."
    dnf5 offline reboot
else
    echo "Χρήση εντολής DNF4..."
    dnf system-upgrade reboot
fi

echo "Η εντολή επανεκκίνησης δόθηκε. Το σύστημά σας θα αναβαθμιστεί."
